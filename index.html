<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - Advanced To-Do App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            transition: width 0.3s ease, padding 0.3s ease;
            position: relative;
            z-index: 100;
        }

        .sidebar.hidden {
            width: 0;
            padding: 0;
            border-right: none;
            overflow: hidden;
        }

        .sidebar-toggle {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            padding: 1rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .sidebar-toggle.sidebar-visible {
            left: 22rem;
        }

        .sidebar h1 {
            color: #4a5568;
            margin-bottom: 2rem;
            font-size: 2rem;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-list-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .new-list-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .standalone-timer-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .standalone-timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .list-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: visible;
        }

        .list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .list-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .list-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .list-title {
            font-weight: bold;
            color: #4a5568;
            flex: 1;
        }

        .delete-list-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .list-item:hover .delete-list-btn {
            opacity: 1;
        }

        .delete-list-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        .list-progress {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 0.5rem;
        }

        .list-timer {
            font-size: 0.8rem;
            color: #e53e3e;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            overflow-y: auto;
        }

        .welcome-screen {
            text-align: center;
            color: white;
            margin-top: 5rem;
        }

        .welcome-screen h2 {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .welcome-screen p {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            color: white;
            margin-top: 4rem;
        }

        .list-header h2 {
            font-size: 2.5rem;
        }

        .timer-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .timer-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .add-task-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-task-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .tasks-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .task-item.completed {
            background: rgba(72, 187, 120, 0.1);
            border-color: #48bb78;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid #cbd5e0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-checkbox.checked {
            background: #48bb78;
            border-color: #48bb78;
        }

        .task-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-text {
            flex: 1;
            font-size: 1.1rem;
            color: #4a5568;
            transition: all 0.3s ease;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .delete-task-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .task-item:hover .delete-task-btn {
            opacity: 1;
        }

        .delete-task-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 3rem;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .close-modal {
            float: right;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            line-height: 1;
            margin-bottom: 1rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .delete-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4);
        }

        .cancel-btn {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            color: #333;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(203, 213, 224, 0.3);
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(203, 213, 224, 0.4);
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 350px;
            animation: pulse 2s infinite;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification h4 {
            margin-bottom: 0.5rem;
        }

        .urgent-notification {
            background: linear-gradient(135deg, #ff4757, #c44569);
            animation: urgentPulse 1s infinite;
        }

        .standalone-timer-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .standalone-timer-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem;
            border-radius: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .big-timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: #333;
            margin: 2rem 0;
            font-family: 'Courier New', monospace;
        }

        .big-timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .big-timer-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .start-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .pause-btn {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .reset-btn {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .close-btn {
            background: linear-gradient(135deg, #cbd5e0, #a0aec0);
            color: #333;
        }

        .alarm-modal {
            background: rgba(255, 0, 0, 0.9);
            animation: alarmFlash 0.5s infinite;
        }

        .alarm-content {
            background: white;
            text-align: center;
            border: 3px solid red;
        }

        .alarm-title {
            color: red;
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .alarm-message {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 2rem;
        }

        .storage-status {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(72, 187, 120, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1002;
        }

        .storage-status.show {
            opacity: 1;
        }

        .storage-status.error {
            background: rgba(229, 62, 62, 0.9);
        }

        @keyframes pulse {
            0% { box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3); }
            50% { box-shadow: 0 10px 30px rgba(255, 107, 107, 0.6); }
            100% { box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3); }
        }

        @keyframes urgentPulse {
            0% { 
                box-shadow: 0 10px 30px rgba(255, 71, 87, 0.5);
                transform: translateX(0) scale(1);
            }
            50% { 
                box-shadow: 0 15px 40px rgba(255, 71, 87, 0.8);
                transform: translateX(0) scale(1.02);
            }
            100% { 
                box-shadow: 0 10px 30px rgba(255, 71, 87, 0.5);
                transform: translateX(0) scale(1);
            }
        }

        @keyframes alarmFlash {
            0% { background: rgba(255, 0, 0, 0.9); }
            50% { background: rgba(255, 100, 100, 0.9); }
            100% { background: rgba(255, 0, 0, 0.9); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .sidebar {
                width: 280px;
                position: fixed;
                height: 100vh;
                z-index: 200;
            }

            .sidebar.hidden {
                width: 0;
                padding: 0;
                border-right: none;
                overflow: hidden;
            }

            .sidebar-toggle {
                left: 1rem;
                top: 1rem;
            }

            .sidebar-toggle.sidebar-visible {
                left: 16rem;
            }

            .main-content {
                padding: 1rem;
            }

            .list-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                margin-top: 5rem;
            }

            .timer-display {
                width: 100%;
                text-align: center;
            }

            .welcome-screen h2 {
                font-size: 2rem;
                margin-top: 3rem;
            }

            .notification {
                top: 1rem;
                right: 1rem;
                left: 1rem;
                transform: translateY(-200px);
                max-width: none;
            }

            .notification.show {
                transform: translateY(0);
            }

            .big-timer-display {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()">
        ☰
    </button>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <h1>TaskFlow</h1>
            <button class="new-list-btn" onclick="openNewListModal()">
                ✨ Create New List
            </button>
            <button class="standalone-timer-btn" onclick="openStandaloneTimer()">
                ⏰ Simple Timer
            </button>
            <div id="lists-container">
                <!-- Lists will be populated here -->
            </div>
        </div>

        <div class="main-content" id="main-content">
            <div id="welcome-screen" class="welcome-screen">
                <h2>🚀 Welcome to TaskFlow</h2>
                <p>Create your first to-do list or use the simple timer!</p>
                <p style="margin-top: 1rem; font-size: 1rem; opacity: 0.5;">Your data is automatically saved!</p>
            </div>

            <div id="list-content" style="display: none;">
                <div class="list-header">
                    <h2 id="current-list-title"></h2>
                    <div class="timer-section">
                        <div class="timer-display" id="timer-display">00:00:00</div>
                        <div class="timer-controls">
                            <button class="timer-btn" onclick="startTimer()">Start</button>
                            <button class="timer-btn" onclick="pauseTimer()">Pause</button>
                            <button class="timer-btn" onclick="resetTimer()">Reset</button>
                        </div>
                    </div>
                </div>

                <div class="add-task-form">
                    <div class="form-group">
                        <label for="task-input">Add New Task</label>
                        <input type="text" id="task-input" placeholder="Enter your task..." onkeypress="handleTaskKeypress(event)">
                    </div>
                    <button class="add-task-btn" onclick="addTask()">Add Task</button>
                </div>

                <div class="tasks-container">
                    <div id="tasks-list">
                        <!-- Tasks will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New List Modal -->
    <div id="new-list-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeNewListModal()">&times;</span>
            <h3>Create New To-Do List</h3>
            <div class="form-group">
                <label for="list-title-input">List Title</label>
                <input type="text" id="list-title-input" placeholder="Enter list title..." onkeypress="handleListKeypress(event)">
            </div>
            <div class="form-group">
                <label for="list-timer-input">Timer Duration (minutes)</label>
                <input type="number" id="list-timer-input" placeholder="30" min="1" max="480">
            </div>
            <button class="add-task-btn" onclick="createNewList()">Create List</button>
        </div>
    </div>

    <!-- Standalone Timer Modal -->
    <div id="standalone-timer" class="modal standalone-timer-modal">
        <div class="modal-content standalone-timer-content">
            <span class="close-modal" onclick="closeStandaloneTimer()">&times;</span>
            <h3>Simple Timer</h3>
            <div class="form-group">
                <label for="standalone-minutes">Minutes</label>
                <input type="number" id="standalone-minutes" placeholder="25" min="1" max="480" value="25">
            </div>
            <div class="big-timer-display" id="standalone-display">25:00</div>
            <div class="big-timer-controls">
                <button class="big-timer-btn start-btn" onclick="startStandaloneTimer()">Start</button>
                <button class="big-timer-btn pause-btn" onclick="pauseStandaloneTimer()">Pause</button>
                <button class="big-timer-btn reset-btn" onclick="resetStandaloneTimer()">Reset</button>
                <button class="big-timer-btn close-btn" onclick="closeStandaloneTimer()">Close</button>
            </div>
        </div>
    </div>

    <!-- Alarm Modal -->
    <div id="alarm-modal" class="modal alarm-modal">
        <div class="modal-content alarm-content">
            <div class="alarm-title">⏰ TIME'S UP!</div>
            <div class="alarm-message" id="alarm-message">Your timer has finished!</div>
            <button class="big-timer-btn confirm-btn" onclick="stopAlarm()">Stop Alarm</button>
        </div>
    </div>

    <!-- Time Up Modal -->
    <div id="time-up-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeTimeUpModal()">&times;</span>
            <h3>⏰ Time's Up!</h3>
            <p id="time-up-message"></p>
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="closeTimeUpModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeConfirmDeleteModal()">&times;</span>
            <h3>Are you sure?</h3>
            <p>This will delete "<span id="delete-list-name"></span>" and all its tasks. This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="delete-btn" onclick="confirmDelete()">Delete</button>
                <button class="cancel-btn" onclick="closeConfirmDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <h4 id="notification-title">⏰ Time Running Out!</h4>
        <p id="notification-message">Only 3 minutes left for your current list!</p>
    </div>

    <!-- Storage Status -->
    <div id="storage-status" class="storage-status">
        Data saved successfully!
    </div>

    <script>
        let lists = [];
        let currentListId = null;
        let timerInterval = null;
        let currentTime = 0;
        let isTimerRunning = false;
        let timerDuration = 0;
        let notificationShown = false;
        let urgentNotificationShown = false;
        let sidebarVisible = true;
        let pendingDeleteListId = null;

        // Standalone timer variables
        let standaloneInterval = null;
        let standaloneTime = 0;
        let standaloneDuration = 1500; // 25 minutes default
        let standaloneRunning = false;
        let standaloneNotificationShown = false;
        let standaloneUrgentNotificationShown = false;
        let alarmSound = null;

        // Storage keys
        const STORAGE_KEYS = {
            LISTS: 'taskflow_lists',
            CURRENT_LIST_ID: 'taskflow_current_list_id',
            SIDEBAR_VISIBLE: 'taskflow_sidebar_visible'
        };

        // Audio context for alarm sound
        function createAlarmSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                function playBeep() {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
                
                return {
                    play: () => {
                        playBeep();
                        setTimeout(() => playBeep(), 600);
                        setTimeout(() => playBeep(), 1200);
                    }
                };
            } catch (e) {
                console.warn('Audio context not available');
                return { play: () => {} };
            }
        }

        // Initialize alarm sound
        alarmSound = createAlarmSound();

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.LISTS, JSON.stringify(lists));
                localStorage.setItem(STORAGE_KEYS.CURRENT_LIST_ID, currentListId);
                localStorage.setItem(STORAGE_KEYS.SIDEBAR_VISIBLE, sidebarVisible);
                showStorageStatus('Data saved successfully!');
                return true;
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
                showStorageStatus('Failed to save data!', true);
                return false;
            }
        }

        function loadFromStorage() {
            try {
                const savedLists = localStorage.getItem(STORAGE_KEYS.LISTS);
                const savedCurrentListId = localStorage.getItem(STORAGE_KEYS.CURRENT_LIST_ID);
                const savedSidebarVisible = localStorage.getItem(STORAGE_KEYS.SIDEBAR_VISIBLE);

                if (savedLists) {
                    lists = JSON.parse(savedLists);
                    // Ensure all lists have required properties
                    lists = lists.map(list => ({
                        id: list.id || Date.now() + Math.random(),
                        title: list.title || 'Untitled List',
                        tasks: list.tasks || [],
                        duration: list.duration || 30,
                        currentTime: list.currentTime || 0,
                        isRunning: false,
                        notificationShown: false,
                        urgentNotificationShown: false
                    }));
                }

                if (savedCurrentListId) {
                    currentListId = parseInt(savedCurrentListId);
                }

                if (savedSidebarVisible !== null) {
                    sidebarVisible = savedSidebarVisible === 'true';
                }

                showStorageStatus('Data loaded successfully!');
                return true;
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                showStorageStatus('Failed to load data!', true);
                return false;
            }
        }

        function showStorageStatus(message, isError = false) {
            const statusElement = document.getElementById('storage-status');
            statusElement.textContent = message;
            statusElement.className = `storage-status ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 2000);
        }

        // Initialize the app
        function init() {
            loadFromStorage();
            renderLists();
            applySidebarState();
            
            if (lists.length > 0) {
                if (currentListId && lists.find(l => l.id === currentListId)) {
                    selectList(currentListId);
                } else {
                    selectList(lists[0].id);
                }
            } else {
                showWelcomeScreen();
            }

            // Handle page visibility change to sync across tabs
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    loadFromStorage();
                    renderLists();
                }
            });
        }

        function applySidebarState() {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebar-toggle');
            
            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                toggle.classList.add('sidebar-visible');
            } else {
                sidebar.classList.add('hidden');
                toggle.classList.remove('sidebar-visible');
            }
        }

        function toggleSidebar() {
            sidebarVisible = !sidebarVisible;
            applySidebarState();
            saveToStorage();
        }

        function showWelcomeScreen() {
            document.getElementById('welcome-screen').style.display = 'block';
            document.getElementById('list-content').style.display = 'none';
            currentListId = null;
        }

        function hideWelcomeScreen() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('list-content').style.display = 'block';
        }

        function renderLists() {
            const container = document.getElementById('lists-container');
            container.innerHTML = '';

            lists.forEach(list => {
                const completedTasks = list.tasks.filter(task => task.completed).length;
                const totalTasks = list.tasks.length;
                const progressPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
                
                const remainingTime = Math.max(0, (list.duration * 60) - list.currentTime);
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const listElement = document.createElement('div');
                listElement.className = `list-item ${currentListId === list.id ? 'active' : ''}`;
                listElement.innerHTML = `
                    <div class="list-header-bar">
                        <div class="list-title">${list.title}</div>
                        <button class="delete-list-btn" onclick="event.stopPropagation(); openDeleteConfirmation(${list.id})">Delete</button>
                    </div>
                    <div class="list-progress">${completedTasks}/${totalTasks} tasks completed</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="list-timer">⏰ ${timerText}</div>
                `;
                
                listElement.onclick = () => selectList(list.id);
                container.appendChild(listElement);
            });
        }

        function selectList(listId) {
            // Stop current timer if running
            if (isTimerRunning) {
                pauseTimer();
            }

            currentListId = listId;
            const list = lists.find(l => l.id === listId);
            
            if (list) {
                hideWelcomeScreen();
                document.getElementById('current-list-title').textContent = list.title;
                renderTasks();
                updateTimerDisplay();
                renderLists();
                saveToStorage();
            }
        }

        function renderTasks() {
            const list = lists.find(l => l.id === currentListId);
            const container = document.getElementById('tasks-list');
            
            if (!list) {
                container.innerHTML = '<p>No tasks yet. Add one above!</p>';
                return;
            }

            if (list.tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">No tasks yet. Add one above!</p>';
                return;
            }

            container.innerHTML = '';
            list.tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskElement.innerHTML = `
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <span class="task-text">${task.text}</span>
                    <button class="delete-task-btn" onclick="deleteTask(${task.id})">Delete</button>
                `;
                container.appendChild(taskElement);
            });
        }

        function addTask() {
            const input = document.getElementById('task-input');
            const text = input.value.trim();
            
            if (!text) return;

            const list = lists.find(l => l.id === currentListId);
            if (!list) return;

            const task = {
                id: Date.now() + Math.random(),
                text: text,
                completed: false
            };

            list.tasks.push(task);
            input.value = '';
            
            renderTasks();
            renderLists();
            saveToStorage();
        }

        function toggleTask(taskId) {
            const list = lists.find(l => l.id === currentListId);
            if (!list) return;

            const task = list.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
                renderLists();
                saveToStorage();
            }
        }

        function deleteTask(taskId) {
            const list = lists.find(l => l.id === currentListId);
            if (!list) return;

            list.tasks = list.tasks.filter(t => t.id !== taskId);
            renderTasks();
            renderLists();
            saveToStorage();
        }

        function handleTaskKeypress(event) {
            if (event.key === 'Enter') {
                addTask();
            }
        }

        // List management functions
        function openNewListModal() {
            document.getElementById('new-list-modal').classList.add('active');
        }

        function closeNewListModal() {
            document.getElementById('new-list-modal').classList.remove('active');
            document.getElementById('list-title-input').value = '';
            document.getElementById('list-timer-input').value = '';
        }

        function handleListKeypress(event) {
            if (event.key === 'Enter') {
                createNewList();
            }
        }

        function createNewList() {
            const title = document.getElementById('list-title-input').value.trim();
            const duration = parseInt(document.getElementById('list-timer-input').value) || 30;
            
            if (!title) return;

            const newList = {
                id: Date.now(),
                title: title,
                tasks: [],
                duration: duration,
                currentTime: 0,
                isRunning: false,
                notificationShown: false,
                urgentNotificationShown: false
            };

            lists.push(newList);
            closeNewListModal();
            selectList(newList.id);
            renderLists();
            saveToStorage();
        }

        function openDeleteConfirmation(listId) {
            const list = lists.find(l => l.id === listId);
            if (list) {
                pendingDeleteListId = listId;
                document.getElementById('delete-list-name').textContent = list.title;
                document.getElementById('confirm-delete-modal').classList.add('active');
            }
        }

        function closeConfirmDeleteModal() {
            document.getElementById('confirm-delete-modal').classList.remove('active');
            pendingDeleteListId = null;
        }

        function confirmDelete() {
            if (pendingDeleteListId) {
                lists = lists.filter(l => l.id !== pendingDeleteListId);
                
                if (currentListId === pendingDeleteListId) {
                    if (lists.length > 0) {
                        selectList(lists[0].id);
                    } else {
                        showWelcomeScreen();
                    }
                }
                
                renderLists();
                saveToStorage();
                closeConfirmDeleteModal();
            }
        }

        // Timer functions
        function updateTimerDisplay() {
            const list = lists.find(l => l.id === currentListId);
            if (!list) return;

            const remainingTime = Math.max(0, (list.duration * 60) - list.currentTime);
            const hours = Math.floor(remainingTime / 3600);
            const minutes = Math.floor((remainingTime % 3600) / 60);
            const seconds = remainingTime % 60;

            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;

            // Check for notifications
            const totalTime = list.duration * 60;
            const fivePercentTime = Math.floor(totalTime * 0.05);
            
            if (remainingTime <= 180 && !list.notificationShown) { // 3 minutes
                showNotification('⏰ Time Running Out!', 'Only 3 minutes left for your current list!', false);
                list.notificationShown = true;
                saveToStorage();
            }
            
            if (remainingTime <= fivePercentTime && !list.urgentNotificationShown) { // 5% of total time
                showNotification('🚨 URGENT!', `Only ${Math.floor(remainingTime/60)}:${(remainingTime%60).toString().padStart(2, '0')} remaining!`, true);
                list.urgentNotificationShown = true;
                saveToStorage();
            }

            if (remainingTime === 0 && isTimerRunning) {
                pauseTimer();
                triggerAlarm(`Time's up for "${list.title}"!`);
            }
        }

        function startTimer() {
            if (!currentListId || isTimerRunning) return;

            const list = lists.find(l => l.id === currentListId);
            if (!list) return;

            const remainingTime = (list.duration * 60) - list.currentTime;
            if (remainingTime <= 0) return;

            isTimerRunning = true;
            list.isRunning = true;
            timerInterval = setInterval(() => {
                list.currentTime++;
                updateTimerDisplay();
                renderLists();
                
                // Auto-save every 10 seconds while timer is running
                if (list.currentTime % 10 === 0) {
                    saveToStorage();
                }
            }, 1000);
        }

        function pauseTimer() {
            isTimerRunning = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const list = lists.find(l => l.id === currentListId);
            if (list) {
                list.isRunning = false;
                saveToStorage();
            }
        }

        function resetTimer() {
            pauseTimer();
            const list = lists.find(l => l.id === currentListId);
            if (list) {
                list.currentTime = 0;
                list.notificationShown = false;
                list.urgentNotificationShown = false;
                updateTimerDisplay();
                renderLists();
                saveToStorage();
            }
        }

        // Standalone timer functions
        function openStandaloneTimer() {
            document.getElementById('standalone-timer').classList.add('active');
            updateStandaloneDisplay();
        }

        function closeStandaloneTimer() {
            pauseStandaloneTimer();
            document.getElementById('standalone-timer').classList.remove('active');
            standaloneNotificationShown = false;
            standaloneUrgentNotificationShown = false;
        }

        function updateStandaloneDisplay() {
            const minutes = document.getElementById('standalone-minutes').value || 25;
            if (!standaloneRunning) {
                standaloneDuration = minutes * 60;
                standaloneTime = 0;
            }
            
            const remainingTime = Math.max(0, standaloneDuration - standaloneTime);
            const displayMinutes = Math.floor(remainingTime / 60);
            const displaySeconds = remainingTime % 60;
            
            document.getElementById('standalone-display').textContent = 
                `${displayMinutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;

            // Check for notifications
            const fivePercentTime = Math.floor(standaloneDuration * 0.05);
            
            if (remainingTime <= 180 && !standaloneNotificationShown) { // 3 minutes
                showNotification('⏰ Timer Alert!', 'Only 3 minutes left on your simple timer!', false);
                standaloneNotificationShown = true;
            }
            
            if (remainingTime <= fivePercentTime && !standaloneUrgentNotificationShown) { // 5% of total time
                showNotification('🚨 TIMER URGENT!', `Only ${Math.floor(remainingTime/60)}:${(remainingTime%60).toString().padStart(2, '0')} remaining!`, true);
                standaloneUrgentNotificationShown = true;
            }

            if (remainingTime === 0 && standaloneRunning) {
                pauseStandaloneTimer();
                triggerAlarm('Your simple timer has finished!');
            }
        }

        function startStandaloneTimer() {
            if (standaloneRunning) return;

            const minutes = parseInt(document.getElementById('standalone-minutes').value) || 25;
            if (standaloneTime === 0) {
                standaloneDuration = minutes * 60;
            }

            const remainingTime = standaloneDuration - standaloneTime;
            if (remainingTime <= 0) return;

            standaloneRunning = true;
            standaloneInterval = setInterval(() => {
                standaloneTime++;
                updateStandaloneDisplay();
            }, 1000);
        }

        function pauseStandaloneTimer() {
            standaloneRunning = false;
            if (standaloneInterval) {
                clearInterval(standaloneInterval);
                standaloneInterval = null;
            }
        }

        function resetStandaloneTimer() {
            pauseStandaloneTimer();
            standaloneTime = 0;
            standaloneNotificationShown = false;
            standaloneUrgentNotificationShown = false;
            updateStandaloneDisplay();
        }

        // Update standalone display when minutes change
        document.addEventListener('DOMContentLoaded', () => {
            const minutesInput = document.getElementById('standalone-minutes');
            if (minutesInput) {
                minutesInput.addEventListener('input', updateStandaloneDisplay);
            }
        });

        // Notification functions
        function showNotification(title, message, isUrgent = false) {
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notification-title');
            const messageElement = document.getElementById('notification-message');

            titleElement.textContent = title;
            messageElement.textContent = message;

            if (isUrgent) {
                notification.classList.add('urgent-notification');
            } else {
                notification.classList.remove('urgent-notification');
            }

            notification.classList.add('show');

            // Auto-hide after 5 seconds as requested
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.classList.remove('urgent-notification');
                }, 300);
            }, 5000);
        }

        function triggerAlarm(message) {
            // Play alarm sound
            if (alarmSound) {
                alarmSound.play();
            }

            // Show alarm modal
            document.getElementById('alarm-message').textContent = message;
            document.getElementById('alarm-modal').classList.add('active');

            // Repeat alarm sound every 3 seconds until stopped
            const alarmInterval = setInterval(() => {
                if (alarmSound) {
                    alarmSound.play();
                }
            }, 3000);

            // Store interval reference for cleanup
            window.currentAlarmInterval = alarmInterval;
        }

        function stopAlarm() {
            document.getElementById('alarm-modal').classList.remove('active');
            
            // Clear alarm sound interval
            if (window.currentAlarmInterval) {
                clearInterval(window.currentAlarmInterval);
                window.currentAlarmInterval = null;
            }
        }

        // Modal close functions
        function closeTimeUpModal() {
            document.getElementById('time-up-modal').classList.remove('active');
        }

        // Initialize app when page loads
        window.addEventListener('load', () => {
            init();
        });

        // Handle page unload to save final state
        window.addEventListener('beforeunload', () => {
            saveToStorage();
        });

        // Auto-save every 30 seconds
        setInterval(() => {
            if (lists.length > 0) {
                saveToStorage();
            }
        }, 30000);

    </script>
</body>
</html>